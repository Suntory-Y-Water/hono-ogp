# OGP画像生成サービス - Claude Code ガイド

## プロジェクト概要

動的にOGP画像を生成するサービスです。HonoXとCloudflare Workersを基盤とし、Satoriを利用してHTML/CSSから画像を生成します。記事タイトル、アイコン、著者名、背景などをカスタマイズ可能です。

- プロジェクト名: OGP画像生成サービス
- プロジェクトタイプ: Webアプリケーション（動的OGP画像生成サービス）
- 主要機能:
  - OGP画像作成フォーム（タイトル、グラデーション選択など）
  - リアルタイムプレビュー機能
  - 生成結果の表示とOGP用URLの発行
  - 画像配信APIエンドポイント
  - （Phase 2）アイコン画像、著者名表示への対応

## 技術スタック

### フロントエンド

- フレームワーク/ライブラリ: HonoX (Islands Architecture)
- スタイリング: Tailwind CSS 4.0
- クライアントサイド: Islands Architectureによる部分的なハイドレーション

### バックエンド

- 言語: TypeScript
- フレームワーク: Hono
- ランタイム: Cloudflare Workers
- データベース: Cloudflare KV (メタデータ), Cloudflare R2 (画像ファイル)
- 画像生成: Satori, svg2png-wasm, wasm-image-optimization

### 開発・インフラ環境

- パッケージマネージャー: pnpm
- テストフレームワーク: Vitest 3.2.4
- リンター: biome 1.9.4
- CI/CD: GitHub Actions
- ホスティング: Cloudflare

## プロジェクト構造

HonoXのfile-based routingに基づいた構成です。

```
app/
├── islands/                  # クライアントサイドで動作するインタラクティブなコンポーネント
│   └── ogp-form.tsx          # OGP設定フォーム
├── lib/                      # サーバーサイドのライブラリ・ユーティリティ
│   ├── cloudflare.ts         # R2/KV統合操作ライブラリ
│   ├── ogp-generator.ts      # Satoriを使った画像生成ロジック
│   └── ogp-template.tsx      # 画像デザインの元となるJSXテンプレート
└── routes/                   # ページのルーティングとAPIエンドポイント
    ├── api/
    │   ├── ogp/
    │   │   ├── [id].tsx      # OGP画像配信エンドポイント
    │   │   └── generate.tsx  # OGP画像生成API
    │   └── ...
    ├── ogp/
    │   ├── index.tsx         # OGP作成フォーム画面
    │   └── result.tsx        # 生成結果表示画面
    └── ...
```

## データベース設計

Cloudflareのストレージサービスを利用してデータを管理します。

- モデル構成:
  - `KV (キー: ogp:${id})`: 画像メタデータを格納。値には画像ID、R2のURL、タイトルやグラデーションなどの生成パラメータ、作成日時を含む。TTLは1年。
  - `R2 (バケット: ogp-images/images)`: 生成されたPNG画像ファイルを格納。ファイル名は`${id}_${Date.now()}_${titleHash}.png`形式。
- 環境別設定 (TODO):
  - 開発:
  - 本番:

## 開発ワークフロー (TODO)

### セットアップ

```bash
# 依存関係インストール
pnpm install

```

### 開発サーバー起動

```bash

# 開発環境の起動
pnpm dev

# ビルド
pnpm build
```

### テスト実行

```bash
# 型定義ファイル作成
pnpm typegen

# 単体テスト
pnpm test:unit

# 結合テスト
pnpm test:it

# オール
pnpm test

```

## テストガイドライン

このプロジェクトでは、Vitestと`@cloudflare/vitest-pool-workers`を組み合わせて、Cloudflare Workersの本番環境を模した統合テストを実施します。APIエンドポイントやデータベース連携など、アプリケーション全体の動作を保証することを目的とします。

- ファイル配置:
  - すべてのテストファイルは、プロジェクトルートの `test/` ディレクトリ内に配置します。
  - ファイル名は `[テスト対象の機能].test.ts` のように、末尾を `.test.ts` とします。

- テスト対象:
  - APIエンドポイント: Honoのアプリケーションインスタンス (`app/server.ts`) にリクエストを送り、ステータスコードやレスポンスを検証します。
  - データベース関数: `app/db.ts`内の関数が、D1データベースを正しく操作できることを検証します。
  - ユーティリティ関数: `app/utils.ts`などの純粋な補助関数をテストします。

- 記述ルール:
  - テストはVitestを使用し、`describe`/`it`構文で記述します。
  - `describe`ブロックは、テストの対象や状況を日本語で分かりやすく記述します。
  - `test/vitest.setup.ts`の設定により、各テストケース (`it`) の実行前にデータベースが自動的にリセットされます。これにより、各テストは常にクリーンな状態で実行されます。
  - テスト内でD1データベースなどのCloudflareリソースを操作するには、`import { env } from 'cloudflare:test';` を使用します。
  - エンドポイントにアクセスするときは`import { SELF, env } from 'cloudflare:test';`して、`const response = await SELF.fetch('http://localhost/');`でアクセスします。

- モック:
  - `@cloudflare/vitest-pool-workers`がCloudflare環境をシミュレートするため、D1データベースやKVなどのバインディングをモックする必要はありません。
  - 外部のサードパーティAPIなど、制御下にない依存関係のみ、`vi.mock`を使用してモックします。

### テストコードは変更しない

テストコードの変更は基本的に禁止。
テストは仕様を表すものであり、実装の正しさを検証するためのものです。

テストが失敗している場合は、実装側を修正してください。
テストコードを実装に合わせるのは禁止。

テストが誤っていると思ったら質問してください。
独自判断でテストを書き換えるのは禁止。

#### テストコードを変更しても良い例外

テストコードを変更して良い例外は以下のような場合です。

- テストを追加するタスクを依頼されている。
- テストを修正するタスクを依頼されている。
- テストコードに明らかな構文エラーがある。
- テスト仕様が矛盾している。
    - この場合は独自に判断するのではなく質問して確認してください。
- テストコードがテスト対象のAPIと互換性がなくなっている。
    - この場合は独自に判断するのではなく質問して確認してください。

### テストデータに依存した条件分岐は避ける

実装コードがテストで使用されている具体的なデータ値を特別扱いすることは基本的に禁止。
具体的なデータ値とは、例えば変数名やテーブル名などです。

データに依存した実装は以下のような問題を引き起こします。

- 脆弱なテスト: テストデータが変更されると実装が機能しなくなる。
- 隠れた仕様: 特定のデータ名に対する特別な処理が明示的な仕様ではなく暗黙的になる。
- 汎用性の欠如: 実際の運用環境では機能しない可能性がある。

## テスト駆動開発

テスト駆動開発では、テストコードを先に書き、その後に実装コードを書きます。
まずテストコードを書いた後、実装コードを書く前に、テストコードがこれで正しいかユーザに確認してください。
## デプロイメント

```bash
pnpm deploy
```

## 重要な設定ファイル

- `wrangler.jsonc`: Cloudflare Workersの設定ファイル。R2バケットやKV名前空間のバインディングを定義。
- `package.json`: プロジェクトの依存関係を管理。`satori`, `svg2png-wasm`などを追加。

## トラブルシューティング

Cloudflare Workersの制限に対応するための考慮事項です。

- よくある問題:
  - CPU時間制限 (10ms): 画像生成処理がタイムアウトする。
      - 対策: Satoriで利用するHTML/CSSテンプレートを極力軽量化する。使用するフォントを限定し、事前に読み込んでおく。画像処理を最小限に抑える。
  - メモリ制限 (128MB): 大きな画像を扱う際にメモリを使い切る。
      - 対策: アップロード・生成する画像のサイズに上限（例: 2MB）を設ける。可能な箇所でストリーミング処理を導入する。
- キャッシュ戦略:
  - 一度生成した画像はR2に保存し、メタデータをKVに格納する。
  - 次回以降同じリクエストがあった場合は、KVのメタデータを参照し、R2から直接画像を返すか、CDNキャッシュを利用する。
  - CDNのキャッシュTTLは長期間（例: 1年）に設定し、エッジでのキャッシュヒット率を高める。

## CI/CD

GitHub Actions で以下を自動実行：

- TypeScriptビルドチェック
- biome リンティング
- Vitest テスト

実行タイミング：

- `main` / `feature` ブランチへのプッシュ
- `main` / `feature` ブランチへのプルリクエスト

## コントリビューション

1. 機能ブランチを作成
2. コード品質チェックを通す（lint + test）
3. 日本語でのコメント・テスト記述
4. プルリクエスト作成

## コード生成規約
### コメント

各ファイルの冒頭には日本語のコメントで仕様を記述する。

出力例

```ts
/**
 * 2点間のユークリッド距離を計算する
 **/
type Point = { x: number; y: number };
export function distance(a: Point, b: Point): number {
  return Math.sqrt((a.x - b.x) ** 2 + (a.y - b.y) ** 2);
}
```

### テスト

- 各機能に対しては必ずユニットテストを実装
- コードを追加で修正したとき、 `pnpm test` がパスすることを常に確認する。

```ts
function add(a: number, b: number) {
  return a + b;
}
test("1+2=3", () => {
  expect(add(1, 2)).toBe(3);
});
```

- 規約: 
  - ハードコードは絶対にしないでください。環境変数や設定ファイルを使用して、柔軟に対応できるようにします。
  - ビジネス上、後から修正を行う可能性がある処理のみ分離する。何でもかんでも単一責任の法則に従って分離すればよいわけではない。
  - コールバック関数以外でのアロー関数の使用禁止(`map((item) => {})`などはコールバックで記述する)
  - 例外が発生する可能性が低い場合の不必要な`try-catch`の使用禁止（バリデーション、フェッチ、DB 接続など、発生確率が極めて高い場所でのみ実装する）
  - `any`型はテストコードのモック関数を除いて、全てのソースコードで定義することを禁止する
  - すべての処理は関数ベースで作成し、クラスの定義は禁止する。
  - 引数が2個以上ある関数はオブジェクトで引数を定義する

## 参考リンク

- [Hono Documentation](https://hono.dev/)
- [Satori - Vercel](https://vercel.com/docs/functions/edge-functions/og-image-generation/og-image-examples#using-satori)
- [Cloudflare Workers Documentation](https://developers.cloudflare.com/workers/)
- [Vitest Documentation](https://vitest.dev/)